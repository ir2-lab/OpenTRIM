# Physics {#physics}

The simulation is based on the following models and approximations:

## Binary Collision Approximation (BCA)

This means that the projectile traveling through the target collides with only one target atom at a time.

Find more information in this [Wikipedia article](https://en.wikipedia.org/wiki/Binary_collision_approximation).

## Random position of target atoms

The crystalline structure of the target is neglected and the positions of target atom are considered random.

## Continuous slowing down approximation

Between nuclear collisions, the projectile loses energy continuously along its path due to its interaction with the target electrons. This is expressed by the electronic stopping power \f$dE/dx\f$.

## Screened Coulomb interactions

The interaction between projectile and target atoms is described by a screened Coulomb potential. The general form of such a potential is

$$
V(r) = \frac{Z_1 Z_2 e^2}{r} \Phi(r/a)
$$

where \f$\Phi\f$ is the screening function and \f$a\f$ the screening length. The function \f$\Phi(x)\f$ satisfies

$$
\Phi(0) = 1, \quad \Phi(\infty)\to 0
$$

The scattering is considered elastic and it is approximated by classical kinematics. For more information on scattering calculations see the \ref XS section in the programming manual.

## Kinetic Monte-Carlo algorithm

The Monte-Carlo simulation of particle transport typically proceeds in the following manner:

1. Insert a projectile ion in the simulation volume with given energy, position and direction. This is handled by the \ref ion_beam class.
2. Sample the particle's distance to the next collision and the impact parameter of that collision. This is a very important part of the whole algorithm and is discussed in more detail in \ref flightpath.
3. Propagate the particle to the collision site using the \ref ion::propagate() function. If a cell boundary is reached before collision then the particle is transferred to the new cell and the algorithm is restarted. If the boundary is an external boundary of the simulation volume, the ion history ends.
4. Subtract the corresponding electronic energy loss and straggling. For details see \ref dedx.
5. Select collision partner. An atom is selected randomly among the atoms of the target material, taking into account the composition and the atomic concentration of its element.
6. Sample energy, angle, etc. of the particle after collision using the function \ref xs_lab::scatter().
7. If the energy of the recoiling target atom is above the displacement threshold, then a recoil ion is produced and stored in a \ref ion_queue "queue" to be processed later.
8. The sequence is repeated from step 2 until either
  - the particle exits the simulation volume, or,
  - the particle energy goes below the cutoff (\ref mccore::parameters::min_energy \f$\sim 1\f$ eV), whereupon the particle stops and remains implanted in the target

The same algorithm is repeated for all recoils generated by the projectile and all secondary and higher generation recoils. This concludes the history for one projectile. 

## Flight Path Selection {#flightpath}

In MC particle transport simulations, the distance to the next collision is typically sampled from the Poisson distribution, \f$p(x) = e^{-N\sigma_0 x}=e^{-x/\ell}\f$, where \f$N\f$ is the atomic density of scattering centers, \f$\sigma_0\f$ the total cross-section and \f$\ell = (N\sigma_0)^{-1}\f$ denotes the mean free path (mfp).

There is a difficulty in employing this type of flight path selection for the Coulomb and screened Coulomb interactions because the total cross-section diverges. This can be circumvented by setting a lower cutoff, either w.r.t. the scattering angle or the recoil energy or some other scattering parameter. Scattering events below the cutoff are ignored. The cutoff value is selected so that the result of the calculation is not affected significantly.

Mendenhall & Weller 2005 set such a lower cutoff for the recoil energy, \f$T_c\f$, which corresponds to the lowest recoil energy of interest in the problem under study. M&W suggest a value in the range of 1 - 10 eV for ion penetration in solids. 

\f$T_c\f$ corresponds to a lower bound \f$\theta_c\f$ for the center-of-mass scattering angle, which can be obtained from 
$$
T_c = T_m \sin^2(\theta_c/2)
$$
For a given reduced energy \f$\epsilon\f$ of the particle, we can find the maximum impact parameter, \f$p_{max}\f$, corresponding to \f$\theta_c\f$ and thus define the effective total cross-section
$$
\sigma_0 = \pi\, p_{max}^2(\epsilon) = 
\int_0^{p_{max}}{2\pi\, p\, dp} =
\int_{\theta_c}^{\pi}{d\sigma(\epsilon,\theta)}
$$

The main steps of the Mendenhall-Weller algorithm are as follows

> **Mendenhall-Weller (MHW) Algorithm:**
> - For a given particle energy \f$E\f$ find the values of \f$p_{max}\f$, \f$\sigma_0\f$ and \f$\ell\f$ corresponding to the recoil energy cutoff \f$T_c\f$
> - Take a random number sample \f$u \in (0,1)\f$
> - If \f$p_{max} < L\f$, where \f$L\f$ is approx. half the interatomic distance, 
>    - \f$p = p_{max} \sqrt{-\log u}\f$
>    - If \f$p>p_{max}\f$ reject the scattering event 
>    - Propagate particle by \f$\ell\f$
> - if \f$p_{max} \geq L\f$ then 
>    - \f$p = \sqrt{u /(\pi N L)}\f$
>    - Propagate particle by \f$L\f$ 

This is essentially the same algorithm as employed by SRIM.

The 2nd part of the algorithm, for \f$p_{max} \geq L\f$, ensures that impact parameters larger than \f$L\f$ do not occur. This is accepted in both SRIM and M&W2005. M&W justify it as follows:

> ... impact parameters larger than half the lattice spacing do not occur, since then one is closer to the adjacent atom.

while Biersack1980 and the SRIM manual (Ch.7) write:

> This
> procedure maintains the atomic density in the target
> without correlating the lateral positions of successive
> target atoms (neglection of lattice structure).

We believe that these propositions are not justified and one can assume a flight path smaller than the interatomic distance without any problems.

We propose to employ a more "standard" procedure for path selection similar to what is done for neutron or photon transport simulations:

> **IPP "standard" algorithm**
> - For a given particle energy \f$E\f$ we have pre-computed \f$p_{max}\f$, \f$\sigma_0=\pi p_{max}^2\f$ and \f$\ell = (N\sigma_0)^{-1}\f$
> - Take 2 random samples \f$u_{1,2} \in (0,1)\f$
> - The path to the next collision is \f$x = -\ell\,\log u_1\f$ [sampled from the Poisson distr.]
> - If 
> $$
>   \frac{x}{E}\frac{dE}{dx} > \delta
> $$
> where \f$\delta\sim 0.05\f$ reject the scattering event
> - \f$p = p_{max}\sqrt{u_2}\f$
> - Propagate particle by \f$x\f$

Although here we need 2 random numbers instead of 1 in the MHW/SRIM algorithm, the penalty is not so high since all outcomes are valid (in M&W algorithm some events are discarted). 

An advantage of this method is that the average mfp of the simulated ions is exactly \f$\ell\f$, which in the MW algorithm is not true. This permits us to preset a value for the mfp. This can be useful, e.g., when simulating thin targets (setting \f$\ell \ll d\f$ ensures scattering in the target)

### Parameters for adjusting flight path selection

A number of different criteria can be used in parallel for setting \f$p_{max}\f$, \f$\sigma_0\f$ and \f$\ell\f$:

- **Recoil energy lower cutoff** \n 
  As explained above, a lower cutoff \f$T_c\f$ in the recoil energy results in a maximum impact parameter \f$p_{max} = p(E,T_c)\f$ and \f$\ell = 1/\sqrt{\pi N p_{max}^2}\f$.

  This can be set by changing the value of \ref mccore::parameters::min_recoil_energy (in eV). The default is 1eV, equal to \ref mccore::parameters::min_energy.

  This parameter is used in both MHW and IPP flight path selection schemes.

- **Upper bound for electronic stopping** \n 
  \f$\Delta E / E = (dE/dx)\,\ell/E< \delta\f$ or \f$\ell < \ell_{max} = \delta \cdot E/(dE/dx)\f$. Typically a \f$\delta\f$ value of 0.01 - 0.05 is employed.

  This is set by \ref mccore::parameters::max_rel_eloss. The default is 0.05.

- **Upper bound for the mfp** \n 
  \f$\ell < \ell_{max}\f$, where \f$\ell_{max}\f$ is set for geometric reasons

A table of these values as a function of incident energy is calculated before starting the main simulation.



